# Kaspi Reporter

Автоматический ежедневный отчёт по нераспознанным товарам из Kaspi Merchant Center.

**Мультимерчант:** Sulpak, ARG (30409770), Motorola (30382295)

## Архитектура

```
test_steps.py        — основной скрипт (авторизация, переключение мерчантов, навигация, скачивание, отчёт)
google_sheets.py     — модуль работы с Google Sheets (добавление товаров, менеджеры, дедупликация, контроль качества)
config.py            — конфигурация (мерчанты, секреты из env или дефолты)
.github/workflows/report.yml — GitHub Actions cron (03:00 UTC = 08:00 Алматы)
```

## Ключевые моменты

### Мерчанты (config.py)
```python
MERCHANTS = [
    {"id": "Sulpak", "name": "Sulpak", "sheet_name": "Sulpak"},
    {"id": "30409770", "name": "ARG", "sheet_name": "ARG"},
    {"id": "30382295", "name": "Motorola", "sheet_name": "Motorola"},
]
```
- `id` — текст после "ID - " в выпадающем списке Kaspi MC
- Переключение через `switch_merchant()` — клик по dropdown в header (y < 80, x > 800)

### Переключение мерчантов (switch_merchant)
1. Переход на базовую страницу `/products/pending`
2. Поиск кнопки с текстом "ID -" в header (справа вверху)
3. Клик для открытия списка
4. Поиск элемента с нужным ID (выбираем самый короткий текст для точного совпадения)
5. Клик и ожидание перезагрузки данных (7 сек + networkidle)
6. Проверка что переключение успешно

### Навигация в Kaspi MC
- SPA с hash-роутингом (`#/products/pending/CHECK/1`)
- Переключение вкладок через клик по `<a>` с текстом категории
- Кнопка "Выгрузить в EXCEL" — это `<a>`, не `<button>`
- Всегда ищем только `:visible` элементы (SPA держит скрытые DOM-элементы)
- **Пропуск категорий с 0 товаров** — проверяем число в скобках вкладки

### Категории нераспознанных товаров
| Ключ | URL-часть | Название |
|------|-----------|----------|
| без_привязки | CHECK | Без привязки |
| требуют_доработок | IMPORTED | Требуют доработок |
| на_проверке | PENDING | На проверке |
| отклонены | TRASH | Отклонены |

### Telegram
- Сводная таблица в `<pre>` с `parse_mode: HTML`
- Формат: одна таблица с колонкой "Кабинет" и категориями
- Данные в формате `всего (на 30000)`, например `64 (57)`
- **Автооткрепление** предыдущих сообщений перед закреплением нового
- Автозакрепление сообщения в группе (бот должен быть админом)
- Ссылка на Google Таблицу с задачами
- **Excel-файлы НЕ отправляются** в Telegram
- Bot API через aiohttp, функции: `send_telegram()`, `unpin_all_telegram_messages()`, `pin_telegram_message()`

### Google Sheets
- Spreadsheet ID: `16NoTXUjutOw_anh_oSuufYEEfEu6FiHGm9OFnrSkdN8`
- Ежемесячные листы (формат: `2026-02`)
- **Столбец A — Кабинет** (Sulpak, ARG, Motorola)
- Товары из "Без привязки" добавляются с назначением менеджера
- **Дедупликация:** артикул не добавляется если уже есть в любом кабинете
- Цвета строк: красный = ARG в названии, зелёный = артикул не на 30000*
- Отслеживание исчезнувших товаров (столбец G)

### Столбец H — Дней до решения
- **Формула:** `=ЕСЛИ(И(F<>"";G="");"ОБМАН";ЕСЛИ(G<>"";G-D;""))` (ОБМАН или Исчезновение - Добавление)
- **Валидация столбца F:** только дата (DATE_IS_VALID)
- **Цветовая маркировка:**
  - `ОБМАН` — красный жирный (отметка менеджера есть, но товар не исчез — обманывает)
  - `1-3` — зелёный (норма, товар обработан вовремя)
  - `> 3` — красный (товар слишком долго висел без привязки)
- Функция `setup_days_column()` настраивает формулы и условное форматирование

### Секреты
В GitHub Secrets (Settings → Secrets → Actions):
- `KASPI_LOGIN`
- `KASPI_PASSWORD`
- `TELEGRAM_BOT_TOKEN`
- `TELEGRAM_CHAT_ID` — ID группы (формат: `-1002158563605`)
- `GOOGLE_CREDENTIALS` — JSON Service Account одной строкой

Локально — дефолтные значения в `config.py`.

## Известные проблемы

1. **GitHub Actions cron задержка** — до 30-60 минут, поэтому cron на 03:00 UTC (08:00 Алматы) чтобы реально пришло ближе к 9:00

2. **cp1251 на Windows** — не использовать emoji в print(), заменять на `[OK]`, `[FAIL]`

3. **Файл заблокирован** — Excel-файлы сохраняем с timestamp и названием мерчанта в имени

4. **Закрепление не работает** — бот должен быть админом группы с правом "Закреплять сообщения"

5. **Переключение мерчанта не работает** — ищем элемент с самым коротким текстом (точное совпадение ID)

6. **Условное форматирование дублируется** — при каждом запуске добавляются новые правила (не критично, работает)

## Команды

```bash
# Локальный запуск (с окном браузера)
py test_steps.py

# Локальный запуск по расписанию (демон)
py test_steps.py --schedule

# Пуш изменений
git add -A && git commit -m "описание" && git push
```

## Контакты
- GitHub: svrual-del/my_progect
- Telegram bot: @KaspiReporterBot (ID: 8510234232)
- Telegram group: -1002158563605
- Google Sheets: https://docs.google.com/spreadsheets/d/16NoTXUjutOw_anh_oSuufYEEfEu6FiHGm9OFnrSkdN8
