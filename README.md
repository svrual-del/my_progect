# Kaspi Reporter

Автоматический ежедневный отчёт по нераспознанным товарам из Kaspi Merchant Center с отправкой сводной таблицы в Telegram.

---

## Возможности

- Авторизация в Kaspi Merchant Center (Email + пароль)
- Сбор данных по 4 категориям нераспознанных товаров:
  - Без привязки
  - Требуют доработок
  - На проверке
  - Отклонены
- Скачивание Excel-выгрузки с каждой категории
- Подсчёт общего количества артикулов и артикулов на 30000* (сторонники)
- Отправка сводного отчёта моноширинной таблицей в Telegram
- Ежедневный запуск в 9:00 по Алматы через GitHub Actions
- Ручной запуск из GitHub или локально

---

## Пример отчёта в Telegram

```
Kaspi Sulpak | 27.01.2026
----------------------------------
Категория        |  Всего|  30000
----------------------------------
Без привязки     |    126|     91
Треб.доработок   |      2|      2
На проверке      |     70|     27
Отклонены        |      1|      1
----------------------------------
ИТОГО            |    199|    121
```

---

## Структура проекта

```
KaspiReporter/
├── .github/
│   └── workflows/
│       └── report.yml       # GitHub Actions: cron 9:00 Алматы
├── config.py                # Конфигурация (секреты из env)
├── test_steps.py            # Основной скрипт
├── requirements.txt         # Зависимости Python
├── .gitignore               # Исключения для git
├── downloads/               # Скачанные Excel (не в git)
└── reports/                 # Отчёты (не в git)
```

---

## Установка

### 1. Клонирование

```cmd
git clone https://github.com/svrual-del/my_progect.git
cd my_progect
```

### 2. Python и зависимости

Требуется Python 3.11+.

```cmd
pip install -r requirements.txt
playwright install chromium
```

### 3. Настройка

Секреты можно задать двумя способами:

**Вариант А: Переменные окружения (для CI/сервера)**

```
KASPI_LOGIN=email@example.com
KASPI_PASSWORD=пароль
TELEGRAM_BOT_TOKEN=1234567890:AAH...
TELEGRAM_CHAT_ID=123456789
```

**Вариант Б: Прямо в config.py (для локального запуска)**

Значения по умолчанию уже прописаны в `config.py`. Измените их на свои.

---

## Запуск

### Локально (разовый)

```cmd
python test_steps.py
```

Откроется окно браузера, пройдёт авторизация, скачаются 4 Excel-файла, отчёт уйдёт в Telegram.

### Локально (по расписанию, 9:00 каждый день)

```cmd
python test_steps.py --schedule
```

Скрипт работает как демон — ждёт до 9:00 и запускает отчёт. Требует постоянно работающего компьютера.

### GitHub Actions (рекомендуется)

Workflow запускается автоматически каждый день в 09:00 по Алматы (04:00 UTC).

Ручной запуск: **Actions -> Kaspi Daily Report -> Run workflow**.

Необходимые секреты в репозитории (Settings -> Secrets -> Actions):

| Secret | Описание |
|---|---|
| `KASPI_LOGIN` | Email для входа в Kaspi MC |
| `KASPI_PASSWORD` | Пароль |
| `TELEGRAM_BOT_TOKEN` | Токен Telegram-бота |
| `TELEGRAM_CHAT_ID` | ID чата для отправки |

---

## Создание Telegram-бота

1. Откройте Telegram, найдите **@BotFather**
2. Отправьте `/newbot`, задайте имя и username
3. Сохраните полученный токен
4. Для получения Chat ID: напишите боту, затем откройте
   `https://api.telegram.org/bot<ТОКЕН>/getUpdates` и найдите `"chat":{"id":...}`

---

## Как это работает

1. **Авторизация** — Playwright открывает Chromium, переходит на страницу входа Kaspi MC, вводит email/пароль
2. **Навигация** — Переход на страницу нераспознанных товаров, клик по вкладкам категорий (SPA с hash-роутингом)
3. **Скачивание** — Нажатие кнопки "Выгрузить в EXCEL" на каждой вкладке
4. **Анализ** — Pandas читает Excel, считает общее количество артикулов и артикулы на 30000*
5. **Отчёт** — Формируется моноширинная таблица, отправляется в Telegram через Bot API

---

## Устранение проблем

| Проблема | Решение |
|---|---|
| Не удалось авторизоваться | Проверьте логин/пароль. Запустите локально без headless |
| Кнопка Excel не найдена | Проверьте что на вкладке есть товары. Kaspi мог изменить вёрстку |
| Скачан файл заказов | Навигация на страницу товаров не сработала. Проверьте URL в config.py |
| Telegram "chat not found" | Напишите боту любое сообщение (бот не может писать первым) |
| GitHub Actions падает | Проверьте секреты в Settings -> Secrets. Посмотрите логи в Actions |

---

## Технологии

- **Python 3.11**
- **Playwright** — автоматизация браузера (Chromium)
- **pandas + openpyxl** — обработка Excel
- **aiohttp** — отправка в Telegram Bot API
- **GitHub Actions** — запуск по расписанию
