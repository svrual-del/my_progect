# Kaspi Reporter

Автоматический ежедневный отчёт по нераспознанным товарам из Kaspi Merchant Center с отправкой в Telegram и интеграцией с Google Sheets для контент-менеджеров.

**Поддержка нескольких мерчантов:** Sulpak, ARG, Motorola

---

## Возможности

- Авторизация в Kaspi Merchant Center (Email + пароль)
- **Мультимерчант:** автоматическое переключение между кабинетами (Sulpak, ARG, Motorola)
- Сбор данных по 4 категориям нераспознанных товаров:
  - Без привязки
  - Требуют доработок
  - На проверке
  - Отклонены
- Скачивание Excel-выгрузки с каждой категории (пропуск категорий с 0 товаров)
- Подсчёт общего количества артикулов и артикулов на 30000* (сторонники)
- **Telegram-отчёт**:
  - Сводная таблица по всем мерчантам с автозакреплением
  - Автооткрепление предыдущих сообщений (закреплён только последний отчёт)
  - Формат: `Кабинет | Без прив. | Треб.дор. | На пров. | Отклон.`
  - Данные в формате `всего (на 30000)`
  - Ссылка на Google Таблицу с задачами
- **Google Sheets интеграция**:
  - Столбец "Кабинет" для разделения товаров по мерчантам
  - Автоматическое добавление новых товаров из "Без привязки"
  - Дедупликация артикулов между кабинетами
  - Распределение задач между контент-менеджерами
  - Цветовая маркировка строк: красный (ARG), зелёный (не 30000*)
  - Отслеживание исчезнувших товаров
  - **Контроль качества работы менеджеров** — столбец "Дней до решения"
- Ежедневный запуск в ~09:00 по Алматы через GitHub Actions
- Ручной запуск из GitHub или локально

---

## Пример отчёта в Telegram

```
Kaspi Report | 13.02.2026
==========================================================
Кабинет   |Без прив. |Треб.дор.| На пров.| Отклон.
----------------------------------------------------------
Sulpak    | 64 (57)  |  2 (2)  | 10 (7)  |  1 (0)
ARG       | 11 (0)   |    0    |    0    |    0
Motorola  |    0     |    0    |    0    |    0
----------------------------------------------------------
ИТОГО     | 75 (57)  |  2 (2)  | 10 (7)  |  1 (0)
==========================================================
Всего товаров: 88 (на 30000: 66)

Задачи контент-менеджерам
```

Сообщение автоматически закрепляется в группе (предыдущие открепляются).

---

## Структура проекта

```
KaspiReporter/
├── .github/
│   └── workflows/
│       └── report.yml       # GitHub Actions: cron 08:00 Алматы (03:00 UTC)
├── config.py                # Конфигурация (мерчанты, секреты из env)
├── test_steps.py            # Основной скрипт
├── google_sheets.py         # Модуль работы с Google Sheets
├── requirements.txt         # Зависимости Python
├── .gitignore               # Исключения для git
├── downloads/               # Скачанные Excel (не в git)
└── reports/                 # Отчёты (не в git)
```

---

## Мерчанты

Настраиваются в `config.py`:

```python
MERCHANTS = [
    {"id": "Sulpak", "name": "Sulpak", "sheet_name": "Sulpak"},
    {"id": "30409770", "name": "ARG", "sheet_name": "ARG"},
    {"id": "30382295", "name": "Motorola", "sheet_name": "Motorola"},
]
```

- `id` — текст в выпадающем списке Kaspi MC после "ID - "
- `name` — название для отчётов и Google Sheets
- `sheet_name` — название листа в Excel (не используется)

---

## Установка

### 1. Клонирование

```cmd
git clone https://github.com/svrual-del/my_progect.git
cd my_progect
```

### 2. Python и зависимости

Требуется Python 3.11+.

```cmd
pip install -r requirements.txt
playwright install chromium
```

### 3. Настройка секретов

**Вариант А: Переменные окружения (для CI/сервера)**

```
KASPI_LOGIN=email@example.com
KASPI_PASSWORD=пароль
TELEGRAM_BOT_TOKEN=1234567890:AAH...
TELEGRAM_CHAT_ID=-1002158563605
```

**Вариант Б: Прямо в config.py (для локального запуска)**

Значения по умолчанию уже прописаны в `config.py`. Измените их на свои.

### 4. Google Sheets (опционально)

1. Создайте проект в [Google Cloud Console](https://console.cloud.google.com/)
2. Включите Google Sheets API и Google Drive API
3. Создайте Service Account и скачайте JSON-ключ
4. Сохраните как `google-credentials.json` в корне проекта
5. Дайте доступ Service Account email к вашей Google Таблице

---

## Запуск

### Локально (разовый)

```cmd
py test_steps.py
```

Откроется окно браузера, пройдёт авторизация, скачаются Excel-файлы для всех мерчантов, отчёт уйдёт в Telegram.

### Локально (по расписанию, 9:00 каждый день)

```cmd
py test_steps.py --schedule
```

Скрипт работает как демон — ждёт до 9:00 и запускает отчёт. Требует постоянно работающего компьютера.

### GitHub Actions (рекомендуется)

Workflow запускается автоматически каждый день в ~09:00 по Алматы (cron 03:00 UTC с учётом задержки GitHub).

Ручной запуск: **Actions → Kaspi Daily Report → Run workflow**.

---

## Секреты GitHub

Settings → Secrets and variables → Actions:

| Secret | Описание |
|---|---|
| `KASPI_LOGIN` | Email для входа в Kaspi MC |
| `KASPI_PASSWORD` | Пароль |
| `TELEGRAM_BOT_TOKEN` | Токен Telegram-бота |
| `TELEGRAM_CHAT_ID` | ID группы (начинается с `-100...`) |
| `GOOGLE_CREDENTIALS` | JSON-ключ Service Account (одной строкой) |

---

## Настройка Telegram-группы

1. Создайте группу или используйте существующую
2. Добавьте бота в группу
3. Сделайте бота **администратором** с правом **"Закреплять сообщения"**
4. Получите Chat ID группы:
   - Добавьте бота `@getmyid_bot` в группу
   - Он покажет ID группы (формат: `-100XXXXXXXXXX`)
5. Обновите `TELEGRAM_CHAT_ID` в секретах GitHub

---

## Google Sheets: структура таблицы

Каждый месяц создаётся новый лист (формат: `2026-02`).

| Столбец | Описание |
|---|---|
| A — Кабинет | Название мерчанта (Sulpak, ARG, Motorola) |
| B — Артикул | SKU товара |
| C — Название товара | Наименование из Kaspi |
| D — Дата добавления | Когда товар появился |
| E — Менеджер | Случайно назначенный контент-менеджер |
| F — Отметка менеджера | Дата обработки (только дата, валидация) |
| G — Дата исчезновения | Когда товар пропал из выгрузки |
| H — Дней до решения | Автоматический расчёт G - F |

### Цветовая маркировка строк:
- Красный фон — товары бренда ARG (приоритет)
- Зелёный фон — артикулы НЕ начинающиеся на 30000

### Цветовая маркировка столбца H (Дней до решения):
| Значение | Цвет | Описание |
|---|---|---|
| **ОБМАН** | Красный (жирный) | Менеджер отметил, но товар ещё в файле |
| < 0 | Красный | Отметка после исчезновения (подозрительно) |
| > 2 | Красный | Обработка заняла более 2 дней |
| 0-2 | Зелёный | Норма — обработано вовремя |

**Дедупликация:** если артикул уже есть в таблице (в любом кабинете), он не добавляется повторно.

---

## Как это работает

1. **Авторизация** — Playwright открывает Chromium, переходит на страницу входа Kaspi MC
2. **Переключение мерчанта** — Клик по выпадающему списку в header, выбор нужного кабинета
3. **Навигация** — Переход на страницу нераспознанных товаров, клик по вкладкам категорий
4. **Скачивание** — Нажатие кнопки "Выгрузить в EXCEL" (пропуск если 0 товаров)
5. **Анализ** — Pandas читает Excel, считает артикулы
6. **Повторение** — Шаги 2-5 для каждого мерчанта
7. **Google Sheets** — Новые товары из "Без привязки" добавляются в таблицу с назначением менеджера
8. **Telegram** — Сводная таблица отправляется, предыдущие открепляются, новая закрепляется

---

## Устранение проблем

| Проблема | Решение |
|---|---|
| Не удалось авторизоваться | Проверьте логин/пароль. Запустите локально без headless |
| Переключение мерчанта не работает | Проверьте ID мерчанта в config.py. Должен совпадать с текстом в списке |
| Кнопка Excel не найдена | Проверьте что на вкладке есть товары. Kaspi мог изменить вёрстку |
| Данные одинаковые для всех мерчантов | Переключение не сработало. Проверьте логи |
| Telegram "chat not found" | Проверьте Chat ID. Для групп он начинается с `-100` |
| Сообщение не закрепляется | Бот должен быть админом с правом "Закреплять сообщения" |
| Google Sheets ошибка | Проверьте что Service Account имеет доступ к таблице |
| GitHub Actions падает | Проверьте секреты в Settings → Secrets. Посмотрите логи в Actions |

---

## Технологии

- **Python 3.11**
- **Playwright** — автоматизация браузера (Chromium)
- **pandas + openpyxl** — обработка Excel
- **gspread + google-auth** — работа с Google Sheets
- **aiohttp** — отправка в Telegram Bot API
- **GitHub Actions** — запуск по расписанию

---

## Контент-менеджеры

Список менеджеров для распределения задач (в `google_sheets.py`):

- Котенко Екатерина Константиновна
- Дементьева Алина Владимировна
- Кононенко Михаил Валерьевич
- Величковская Алиса Леонидовна
- Асреп Жулдыз Ерланкызы
- Тохсеитова Диана Жорабековна
- Сариева Дана Агадилдақызы

Задачи распределяются случайно среди менеджеров с минимальной загрузкой.
